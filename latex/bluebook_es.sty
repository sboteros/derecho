%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Traducción y cambios menores por Santiago Botero Sierra, original tomado
%% de https://sourceforge.net/projects/lawtex/
%% sboteros@unal.edu.co
%% 2020/02/13
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%===============================================================================
% bluebook.sty - Automated Bluebook citations
% Copyright (C) 2009-2013  Christopher De Coro
%
% This file is part of the LaWTeX package, for more information, see:
%   Project Homepage: http://www.cs.princeton.edu/~cdecoro/lawtex/
%   Code Repository: https://sourceforge.net/projects/lawtex/
%
% This program is free software: you can redistribute it and/or modify
% it under the terms of the GNU General Public License as published by
% the Free Software Foundation, either version 3 of the License, or
% (at your option) any later version.
%
% This program is distributed in the hope that it will be useful,
% but WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
% GNU General Public License for more details.
%
% You should have received a copy of the GNU General Public License
% along with this program.  If not, see <http://www.gnu.org/licenses/>.
%===============================================================================

%TODO:
%If short cite to "supra" is in same note, omit "note"
%Make SetIndexName work for all source types (currently just statutes)

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{bluebook_es}[2011/11/11 Legal Bluebook-style Citations]

\RequirePackage{ifthen}
\RequirePackage{multind}
\RequirePackage{xstring}
\RequirePackage{xspace}
\RequirePackage{url}
\def\url@leostyle{\def\UrlFont{\footnotesize\ttfamily}}
\urlstyle{leo}

%Internal global variables
\newcommand{\@bbSignal}{}
\newcommand{\@bbLastSource}{}         %Holds the last source, used for determining Id
\newcommand{\@bbLastPinPage}{}        %Holds the pin page of the last source, used for determining Id
\newcommand{\@bbLastVol}{}            %Holds the pin page of the last source, used for determining Id
\newboolean{@bbCapNextSource}         %Used by the intro signals to supress capitalization of the next Id
\setboolean{@bbCapNextSource}{true}   %By default, Id is capitalized
\newboolean{@bbInFootnote}            %We redefine \footnote to set this
\newboolean{@bbLawReviewMode}
\setboolean{@bbLawReviewMode}{false}
\newcounter{@bbSequentialIds}

%Helper rountines - we should consider if these need to be renamed to avoid clashes
\def\Def#1#2{\expandafter\def\csname#1\endcsname{#2}}
\def\EDef#1#2{\expandafter\edef\csname#1\endcsname{#2}}
\def\ProtectedEDef#1#2{\expandafter\protected@edef\csname#1\endcsname{#2}}
\def\XDef#1#2{\expandafter\xdef\csname#1\endcsname{#2}}
\def\ProtectedXDef#1#2{\expandafter\protected@xdef\csname#1\endcsname{#2}}
\def\GDef#1#2{\expandafter\gdef\csname#1\endcsname{#2}}
\def\Call#1{\csname#1\endcsname}
\def\SafeUnskip{\ifvmode\relax\else\unskip\fi}
\def\globalsetboolean#1#2{\globaldefs=1\setboolean{#1}{#2}\globaldefs=0\relax}

\def\ifempty#1#2#3{\if\relax\expandafter\detokenize\expandafter{#1}\relax #2\else #3\fi}
\def\ifpin#1{\ifempty{##2}{}{#1}}
\def\FillIn#1#2#3{\noexpand\edef\@tmp{#2}\ifempty{\@tmp}{}{#1#2#3}}
\def\IfFootnote#1{\ifthenelse{\boolean{@bbInFootnote}}{#1}{}}

\newcommand{\citecase}[2][]{%
	%Find the first space and paren, and cut it and everything else after as the parenthetical
	\StrPosition{#2}{ (}[\@parenpos]%
	\StrGobbleLeft{#2}{\numexpr \@parenpos-1}[\@paren]%
	\StrLeft{#2}{\numexpr \@parenpos-1 }[\@withoutparen]%
%
	%With the parenthetical gone, we look for the LAST comma, and assume the citation is there to the end
	\StrCount{\@withoutparen}{,}[\@commacount]%
	\StrPosition[\@commacount]{\@withoutparen}{,}[\@lastcommapos]%
	\StrGobbleLeft{\@withoutparen}{\@lastcommapos}[\@citation]%
	\StrLeft{\@withoutparen}{\numexpr \@lastcommapos-1}[\@withoutcitation]%
	\edef\casename{\@withoutcitation}
%
	%Looking only at the citation, assume that from the LAST space to the end is the start page
	\StrCount{\@citation}{ }[\@spacecount]%
	\StrPosition[\@spacecount]{\@citation}{ }[\@lastspacepos]%
	\StrGobbleLeft{\@citation}{\@lastspacepos}[\@startpage]%
	\StrLeft{\@citation}{\numexpr \@lastspacepos-1}[\@reporter]%
%
	%The reporter may have a leading space, if so, chop it
	\StrChar{\@reporter}{1}[\@firstchar]%
	\IfEq{\@firstchar}{ }{\StrGobbleLeft{\@reporter}{1}[\@reporter]}{}%
%
	%The parenthetical may have a leading space, if so, chop it
	\StrChar{\@paren}{1}[\@firstchar]%
	\IfEq{\@firstchar}{ }{\StrGobbleLeft{\@paren}{1}[\@paren]}{}%
%
	%Finally, cut out the second party
	\IfSubStr{\@withoutcitation}{ v. }{\StrBefore{\@withoutcitation}{ v. }[\@firstpartyname]}{\edef\@firstpartyname{\@withoutcitation}}%
	\IfSubStr{\@withoutcitation}{ v. }{\StrBehind{\@withoutcitation}{ v. }[\@secondpartyname]}{}%
%
	%By default, the shortname is set to the first party
	\edef\@shortname{\@firstpartyname}%
%
	%If first party is United States, State, People, or Commonwealth use second party as short name
	\IfEq{\@firstpartyname}{United States}{\edef\@shortname{\@secondpartyname}}{}%
	\IfEq{\@firstpartyname}{State}{\edef\shortname{\@secondpartyname}}{}%
	\IfEq{\@firstpartyname}{People}{\edef\shortname{\@secondpartyname}}{}%
	\IfEq{\@firstpartyname}{Commonwealth}{\edef\shortname{\@secondpartyname}}{}%
%
	%If a short name is given explicitly, use that to override
	\IfEq{#1}{}{}{\edef\@shortname{#1}}%
%
	\newcase{\@shortname}{\@withoutcitation}{\@reporter}{\@startpage}{\@paren}%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Aquí están las partes de los tipos de documentos.
\newcommand{\newcase}[6][empty]{
	\EDef{#2@Type}{Case}
	\EDef{#2@IndexType}{Case}
	\EDef{#2@ShortName}{#2}
	\ProtectedEDef{#2@FullName}{#3}
	\EDef{#2@Reporter}{#4}
	\EDef{#2@StartPage}{#5}
	\EDef{#2@Parenthetical}{#6}
	\newboolean{#2@FirstUse}
	\setboolean{#2@FirstUse}{true}
	\XDef{#2@LastNote}{0}
}

\newcommand{\newbook}[4]{
	\begingroup
		\def\textit##1{##1}
		\def\emph##1{##1}
		\def\textsc##1{##1}
		\xdef\@HandleName{#1}
		\XDef{\@HandleName @Type}{Book}
		\XDef{\@HandleName @IndexType}{Other}
		\XDef{\@HandleName @Authors}{#2}
		\ProtectedXDef{\@HandleName @Title}{#3}
		\GDef{\@HandleName @Parenthetical}{#4}
%
		\globaldefs=1
		\newboolean{\@HandleName @FirstUse}
		\setboolean{\@HandleName @FirstUse}{true}
		\globaldefs=0
	\endgroup%
%
	\XDef{\@HandleName @LastNote}{0}%
	\GDef{\@HandleName @ShortName}{#1}%
}

\newcommand{\newarticle}[6]{
	\begingroup
		\def\textit##1{##1}
		\def\emph##1{##1}
		\xdef\@HandleName{#1}
		\XDef{\@HandleName @Type}{Article}
		\XDef{\@HandleName @IndexType}{Other}
		\XDef{\@HandleName @Authors}{#2}
		\XDef{\@HandleName @Title}{#3}
		\ProtectedXDef{\@HandleName @Reporter}{#4}
		\XDef{\@HandleName @StartPage}{#5}
		\XDef{\@HandleName @Parenthetical}{#6}
%
		\globaldefs=1
		\newboolean{\@HandleName @FirstUse}
		\setboolean{\@HandleName @FirstUse}{true}
		\globaldefs=0
	\endgroup%
%
	\XDef{\@HandleName @LastNote}{0}%
	\GDef{\@HandleName @ShortName}{#1}%
}

\newcommand{\newcollection}[2]{
	\begingroup
		\def\textit##1{##1}
		\def\emph##1{##1}
		\def\textsc##1{##1}
		\xdef\@HandleName{#1}
		\XDef{\@HandleName @Type}{Collection}
		\XDef{\@HandleName @IndexType}{}%The collection itself is not listed in the index
		\XDef{\@HandleName @Title}{#1}
		\GDef{\@HandleName @Parenthetical}{#2}
%
		\globaldefs=1
		\provideboolean{\@HandleName @FirstUse}
		\setboolean{\@HandleName @FirstUse}{true}
		\globaldefs=0
	\endgroup%
%
	\XDef{\@HandleName @LastNote}{0}%
	\GDef{\@HandleName @ShortName}{#1}%
}

\newcommand{\newincollection}[6]{
\tracingmacros=2
	\begingroup
		\def\textit##1{##1}
		\def\emph##1{##1}
		\def\textsc##1{##1}
		\xdef\@HandleName{#1}
		\XDef{\@HandleName @Type}{InCollection}
		\XDef{\@HandleName @IndexType}{Other}
		\XDef{\@HandleName @Authors}{#2}
		\XDef{\@HandleName @Title}{#3}
		\XDef{\@HandleName @CollectionTitle}{#4}
		\GDef{\@HandleName @StartPage}{#5}
		\GDef{\@HandleName @Parenthetical}{#6}
%
		\globaldefs=1
		\newboolean{\@HandleName @FirstUse}
		\setboolean{\@HandleName @FirstUse}{true}
		\globaldefs=0
	\endgroup%
%
	\XDef{\@HandleName @LastNote}{0}%
	\GDef{\@HandleName @ShortName}{#1}%
%
	\newcollection{#4}{#6}%
}

\newcommand{\newinsingleauthorcollection}[6]{
\tracingmacros=2
	\begingroup
		\def\textit##1{##1}
		\def\emph##1{##1}
		\def\textsc##1{##1}
		\xdef\@HandleName{#1}
		\XDef{\@HandleName @Type}{InSingleAuthorCollection}
		\XDef{\@HandleName @IndexType}{Other}
		\XDef{\@HandleName @Authors}{#2}
		\XDef{\@HandleName @Title}{#3}
		\XDef{\@HandleName @CollectionTitle}{#4}
		\GDef{\@HandleName @StartPage}{#5}
		\GDef{\@HandleName @Parenthetical}{#6}
		%\XDef{\@HandleName @FullName}{#1}
%
		\globaldefs=1
		\newboolean{\@HandleName @FirstUse}
		\setboolean{\@HandleName @FirstUse}{true}
		\globaldefs=0
	\endgroup%
%
	\XDef{\@HandleName @LastNote}{0}%
	\GDef{\@HandleName @ShortName}{#1}%
%
	\newcollection{#4}{#6}%
}

\newcommand{\newstatute}[2]{
	\begingroup
		\xdef\@HandleName{#1}
		\XDef{\@HandleName @Type}{Statute}
		\XDef{\@HandleName @IndexType}{Statute}

		\XDef{\@HandleName @ShortName}{#1}
		\XDef{\@HandleName @IndexName}{#1 !}
		\XDef{\@HandleName @Parenthetical}{#2}

		\globaldefs=1
		\newboolean{\@HandleName @FirstUse}
		\setboolean{\@HandleName @FirstUse}{true}
		\globaldefs=0
	\endgroup
%
	\XDef{\@HandleName @LastNote}{0}%
}

\newcommand{\newmisc}[2]{
	\Def{#1@Type}{Misc}
	\Def{#1@IndexType}{Other}
	\EDef{#1@ShortName}{#1}
	\Def{#1@FullName}{#2}
	\newboolean{#1@FirstUse}
	\setboolean{#1@FirstUse}{true}
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%Helper routine to chop up a citation string into its constituent parts
%I think this was for multiple-reporter cites, but it is not yet implemented
\newcommand{\chopcitation}[4]{
	%With the parenthetical gone, we look for the LAST comma, and assume the citation is there to the end
	\StrCount{#1}{,}[\commacount]%
	\StrPosition[\commacount]{#1}{,}[\lastcommapos]%
	\StrGobbleLeft{#1}{\lastcommapos}[\citation]%
	\StrLeft{#1}{\numexpr \lastcommapos-1}[#2]%
%
	%Looking only at the citation, assume that from the LAST space to the end is the start page
	\StrCount{\citation}{ }[\spacecount]%
	\StrPosition[\spacecount]{\citation}{ }[\lastspacepos]%
	\StrGobbleLeft{\citation}{\lastspacepos}[#4]%
	\StrLeft{\citation}{\numexpr \lastspacepos-1}[\reporter]%
%
	%The reporter may have a leading space, if so, chop it
	\StrChar{\reporter}{1}[\firstchar]%
	\IfEq{\firstchar}{ }{\StrGobbleLeft{\reporter}{1}[#3]}{}%
}

%The command \@absorbperiod will remove the . from the token stream.
%If this invocation is followed by a period, we remove it from the stream, but tell \bbsource to add it later (with flag "p")
%Otherwise, \bbsource should not add a period, and use xspace to keep any space afterwards

\def\@startcitation{}
\def\@absorbperiod.{}

\renewcommand{\cite}[2][]{\@startcitation\@ifnextchar.{\@bbsource{#2}{}{#1.}\@absorbperiod}{\@bbsource{#2}{}{#1}\xspace}}
\newcommand{\pincite}[3][]{\@startcitation\@ifnextchar.{\@bbsource{#2}{#3}{#1.}\@absorbperiod}{\@bbsource{#2}{#3}{#1}\xspace}}

\newcommand{\Id}[1][]{\@ifnextchar.{\@bbId{#1}{I.}\@absorbperiod}{\@bbId{#1}{I}}}
\newcommand{\id}[1][]{\@ifnextchar.{\@bbId{#1}{i.}\@absorbperiod}{\@bbId{#1}{i}}}
\def\@bbId#1#2{\@bbsource{\@bbLastSource}{\ifempty{#1}{\@bbLastPinPage}{#1}}{#2}}

\def\citetext#1{\@autofootnote{#1}}

\def\@absorb#1{}
\def\absorb{\aftergroup\@absorb}

\def\@CapLeadingSignal{\futurelet\@NextToken\@@CapLeadingSignal}
\def\@@CapLeadingSignal{\begingroup%
                           \ifx\@NextToken\see\See\globalsetboolean{@bbCapNextSource}{false}\absorb\else%
                           \ifx\@NextToken\seealso\Seealso\globalsetboolean{@bbCapNextSource}{false}\absorb\else%
                           \ifx\@NextToken\seeeg\Seeeg\globalsetboolean{@bbCapNextSource}{false}\absorb\else%
                           \ifx\@NextToken\cf\Cf\globalsetboolean{@bbCapNextSource}{false}\absorb\else%
                           \ifx\@NextToken\butsee\Butsee\globalsetboolean{@bbCapNextSource}{false}\absorb\else%
                           \ifx\@NextToken\butcf\Butcf\globalsetboolean{@bbCapNextSource}{false}\absorb\else%
                           \ifx\@NextToken\accord\Accord\globalsetboolean{@bbCapNextSource}{false}\absorb\else%
                           \ifx\@NextToken\contra\Contra\globalsetboolean{@bbCapNextSource}{false}\absorb\else%
                           \ifx\@NextToken\id\Id\absorb\else%
                           \relax\fi\fi\fi\fi\fi\fi\fi\fi\fi\endgroup}

\newcommand{\citeclause}[1]{%
	\ifthenelse{\boolean{@bbLawReviewMode} \and \not \boolean{@bbInFootnote}}
	{%
		%In the case that we are in the body text in law review mode,
		%add a comma, then the footnote UNLESS the next char is a period
		\@ifnextchar.{%
			\unskip{.}\footnote{\@CapLeadingSignal#1.}\@absorbperiod}
		{%
			\unskip,\footnote{\@CapLeadingSignal#1.} }%
	}{%
		%In the case that we will be inserting a citation in the flow of the text,
		%surround the citation with commas, UNLESS a period follows, in which case only add a leading comma
		\@ifnextchar.{\unskip, #1}{\unskip, #1,\xspace}%
	}%
}

\newcommand{\@autofootnote}[1] {%
	\ifthenelse{\not \boolean{@bbLawReviewMode} \or \boolean{@bbInFootnote}}%
	{%
		#1%
	}
	{%
		\SafeUnskip\footnote{#1}%
	}%
}

\newcommand{\Reporter}[1]{\Call{#1@Reporter}}
\newcommand{\ShortName}[1]{\Call{#1@ShortName}}
\newcommand{\FullName}[1]{\Call{#1@FullName}}
\newcommand{\StartPage}[1]{\Call{#1@StartPage}}
\newcommand{\Parenthetical}[1]{\Call{#1@Parenthetical}}
\newcommand{\Authors}[1]{\Call{#1@Authors}}
\newcommand{\Title}[1]{\Call{#1@Title}}
\newcommand{\CollectionTitle}[1]{\Call{#1@CollectionTitle}}
\newcommand{\Sec}[1]{\Call{#1@Section}}
\newcommand{\Vol}[1]{\Call{#1@Volume}}
\newcommand{\Prefix}[1]{\Call{#1@Prefix}}
\newcommand{\SrcType}[1]{\Call{#1@Type}}
\newcommand{\SupraNote}[1]{\Call{#1@SupraNote}}
\newcommand{\LastNote}[1]{\Call{#1@LastNote}}

\newcommand{\IndexType}[1]{\Call{#1@IndexType}}
\newcommand{\SetIndexType}[2]{\EDef{#1@IndexType}{#2}}

\newcommand{\IndexName}[1]{\Call{#1@IndexName}}
\newcommand{\SetIndexName}[2]{\EDef{#1@IndexName}{#2}}

\newcommand{\@bbLink}[1]{#1}

\newcommand{\@bbCaseIndexCite}[2]{{\CF\@bbLink{\FullName{#1}}},\idxbreak\ \Reporter{#1}~\StartPage{#1} \Parenthetical{#1}}
\newcommand{\@bbBookIndexCite}[2]{\Authors{#1},\idxbreak\ {\em\Title{#1}} \Parenthetical{#1}}
\newcommand{\@bbStatuteIndexCite}[2]{\IndexName{#1}#2}
\newcommand{\@bbArticleIndexCite}[2]{\Authors{#1}, {\ATF\Title{#1}},\idxbreak\ {\JTF\Reporter{#1}}~\StartPage{#1} \Parenthetical{#1}}
\newcommand{\@bbInCollectionIndexCite}[2]{\Authors{#1}, \Title{#1}}
\newcommand{\@bbInSingleAuthorCollectionIndexCite}[2]{\Authors{#1}, \Title{#1}}

\def\@bbMiscIndexCite#1#2{\FullName{#1}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Aquí empieza la forma en que se cita en forma larga y corta.
%% Elementos traducidos al español
%Long-form citation, with and without a pin cite
\newcommand{\@bbCaseLongCite}[2]{{\CF\FullName{#1}},\ \Reporter{#1}~\StartPage{#1}\FillIn{, }{#2}{} \Parenthetical{#1}}
\newcommand{\@bbStatuteLongCite}[2]{\ShortName{#1} #2\FillIn{ }{\Parenthetical{#1}}{}}
\newcommand{\@bbBookLongCite}[2]{\FillIn{}{\@vol}{ }{\BAF\Authors{#1}}, {\BTF\Title{#1}}\FillIn{ }{#2}{}\ \Parenthetical{#1}}
\newcommand{\@bbArticleLongCite}[2]{\Authors{#1}, {\ATF\Title{#1}}, {\JTF\Reporter{#1}} \StartPage{#1}\FillIn{, }{#2}{} \Parenthetical{#1}\unskip}
\newcommand{\@bbInCollectionLongCite}[2]{\Authors{#1}, {\ATF\Title{#1}}, \emph{ en } \@bbsource{\CollectionTitle{#1}}{\StartPage{#1}, #2}{}}
\newcommand{\@bbInSingleAuthorCollectionLongCite}[2]{\FillIn{}{\@vol}{ }{\BAF\Authors{#1}}, {\ATF\Title{#1}}, \emph{ en } \@bbsource{\CollectionTitle{#1}}{\StartPage{#1}, #2}{}}
\newcommand{\@bbCollectionLongCite}[2]{\FillIn{}{\@vol}{ }{\BTF\Title{#1}}\FillIn{, }{#2}{} \Parenthetical{#1}}
\def\@bbMiscLongCite#1#2{{\def\pin##1##2{\FillIn{##1}{#2}{##2}}\FullName{#1}}}

%Short-form citation, with and without a pin cite
\newcommand{\@bbCaseShortCite}[2]{{\em\ShortName{#1}}, \ifdefined\@bbCaseSupra{{\em supra}, }\fi\Reporter{#1}\penalty100\ifempty{#2}{\ \StartPage{#1}}{\ en ~#2}}
\newcommand{\@bbBookShortCite}[2]{\FillIn{}{\@vol}{ }{\BTF\ShortName{#1}}, {\em supra}\IfFootnote{ nota \SupraNote{#1}}\ifpin{, en #2}}
\newcommand{\@bbStatuteShortCite}[2]{\ShortName{#1} #2}
\newcommand{\@bbArticleShortCite}[2]{\ShortName{#1}, {\em supra}\IfFootnote{ nota \SupraNote{#1}}\ifpin{, en #2}}
\newcommand{\@bbInCollectionShortCite}[2]{\ShortName{#1}, {\em supra}\IfFootnote{ nota \SupraNote{#1}}\ifpin{, en #2}}
\newcommand{\@bbInSingleAuthorCollectionShortCite}[2]{\FillIn{}{\@vol}{ }{\BTF\ShortName{#1}}, {\em supra}\IfFootnote{ nota \SupraNote{#1}}\ifpin{, en #2}}
\newcommand{\@bbCollectionShortCite}[2]{\FillIn{}{\@vol}{ }{\BTF\Title{#1}}, \emph{supra}\IfFootnote{ nota \SupraNote{#1}},\ifpin{ en #2}}
\newcommand{\@bbMiscShortCite}[2]{\ShortName{#1}\ifpin{ #2}}

%Reporter-number-only citation, with and without a pin cite
\newcommand{\@bbReporterOnlyCite}[1]{\Reporter{#1} \StartPage{#1}}
\newcommand{\@bbReporterOnlyPinCite}[2]{\Reporter{#1}\penalty100\ en ~#2}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%Dispatch a call to the type-specific citation form
\newcommand{\@bbIndexCite}[2]{\Call{@bb\SrcType{#1}IndexCite}{#1}{#2}}
\newcommand{\@bbLongCite}[2]{{\protect\frenchspacing\Call{@bb\SrcType{#1}LongCite}{#1}{#2}}}
\newcommand{\@bbShortCite}[2]{{\protect\frenchspacing\Call{@bb\SrcType{#1}ShortCite}{#1}{#2}}}

%Inner command that performs the citations
% #1 is cite handle, #2 is pin or blank, #3 can include any of 'lsniIp'
\newcommand{\@bbsource}[3]
{%
	%Check that this source is defined
	\ifcsname #1@Type\endcsname%
		\relax%
	\else
		\errmessage{No source named #1 has been defined}
	\fi%
%
%
	%If user has passed "!", temporarily set autofootnote to do nothing
	%It is the case that all printing commands go through autofootnote
	\let\@@autofootnote=\@autofootnote%
	\IfSubStr{#3}{!}{\def\@autofootnote##1{}}{}%
%
	%If we are going to put this in an autofootnote, we want to take out the preceeding space
	%Additionally, add a period if a '.' has been set in the flags (which means that a period followed \cite), add a period.
	%This period, if it exists, will be stored in \@Period, which is used later on
	\def\@Period{}%
	\ifthenelse{\not \boolean{@bbLawReviewMode} \or \boolean{@bbInFootnote}}{}{\SafeUnskip}%
	\IfSubStr{#3}{.}{\def\@Period{.}}{}%
%
	\provideboolean{@forceLong}%
	\provideboolean{@forceShort}%
	\IfSubStr{#3}{l}{\setboolean{@forceLong}{true}}{\setboolean{@forceLong}{false}}%
	\IfSubStr{#3}{s}{\setboolean{@forceShort}{true}}{\setboolean{@forceShort}{false}}%
%
	%If ``n'' is provided in optional arg, force reporter and page number only (just for Cases)
	\IfSubStr{#3}{n}
	{%
		\ifthenelse{\equal{#2}{}}
			{\@autofootnote{\@bbSignal\@bbReporterOnlyCite{#1}}}
			{\@autofootnote{\@bbSignal\@bbReporterOnlyPinCite{#1}{#2}}}%
%
		%By definition, this last cite cannot be an "id", so reset the id counter
		\setcounter{@bbSequentialIds}{0}%
	}
	{%
		%Pull the volume number out of the pincite, or see if provided
		%The reason it is so messy looking is to deal with the fact that we do not want to fully expand the pincite,
		%  in case it contains formatting or other non-expandable control sequences
		\protected@edef\@fullpin{#2}%
		\expandarg%
		\StrBetween{\@fullpin}{vol. }{, }[\@vol]%
		\edef\@fullvol{vol. \@vol, }%
		\StrDel{\@fullpin}{\@fullvol}[\@pin]%
		\fullexpandarg%
%\show\@pin
%
		%If this authority has not been seen before, or we have not seen it in N notes, use complete form
		\ifthenelse{\boolean{#1@FirstUse} \or \boolean{@forceLong} \or%
			\( \boolean{@bbLawReviewMode} \and \( \equal{\SrcType{#1}}{Case} \or \equal{\SrcType{#1}}{Statute} \) \and
				\(	\( \not \boolean{@bbInFootnote} \and \numexpr\thefootnote-\LastNote{#1}+1\relax > \forcelongevery \) \or
					\( \boolean{@bbInFootnote} \and \numexpr\thefootnote-\LastNote{#1}\relax > \forcelongevery \)
				\)
			\) }%
		{%
%\show\@pin
			\@autofootnote{\@bbSignal\@bbLongCite{#1}{\@pin}\@Period}%
			\setcounter{@bbSequentialIds}{0}%
			\ifthenelse{\boolean{#1@FirstUse}}{\XDef{#1@SupraNote}{\thefootnote}}{}%
		}
		{%
			%If this is the second occurance of this authority in a row, use Id
			\ifthenelse{\equal{\@bbLastSource}{#1} \and \not \boolean{@forceShort}%
				\and \value{@bbSequentialIds} < \maxsequentialids}
			{%
				%We only display the volume if it exists, and is DIFFERENT from the last; otw clear out
				\ifthenelse{\equal{\@vol}{\@bbLastVol}}{\edef\@vol{}}{}%
%
				%Choose either id/Id based on the capitalization flag
				\def\@Id{\ifthenelse{\boolean{@bbCapNextSource} \and \equal{\@vol}{}}{Id}{id}}%
%
				%The capitalization can be overridden based on the optional argument
				\IfSubStr{#3}{I}{\def\@Id{Id}}{}%
				\IfSubStr{#3}{i}{\def\@Id{id}}{}%
%
				%Choose either ``at'' or just a space based on the type of authority
				%\def\@At{\ifthenelse{\equal{\SrcType{#1}}{Statute}}{~}{~at~}}%
				%ALTERNATE: Use "at" iff the pin is numeric
				\def\@At{~}%
				\IfInteger{\@pin}{\def\@At{~ en ~}}{}% %% Traducción
%
				%If the exact page as well (or there is no pincite), just use id; otherwise use Id. with pin cite
				\ifthenelse{\equal{\@bbLastPinPage}{#2} \or \equal{}{#2} }
					%{\@autofootnote{\@bbSignal\FillIn{}{\@vol}{ }\emph{\@Id}\@Period}} %I eliminated this because I found cases where there was no way to have a period after the Id.
					{\@autofootnote{\@bbSignal\FillIn{}{\@vol}{ }\emph{\@Id\@Period}}}%
					{\@autofootnote{\@bbSignal\FillIn{}{\@vol}{ }\emph{\@Id.}\@At\@pin\@Period}}%
				\stepcounter{@bbSequentialIds}%
			}%
			{%
				%If this is not the second-in-a-row occurence of this authority, use short form
				\@autofootnote{\@bbSignal\@bbShortCite{#1}{\@pin}\@Period}%
				\setcounter{@bbSequentialIds}{0}%
			}%
		}%
	}%
%
	%Indicate that this source has been used, so subsequent uses use short form
	%This gets into the internals of ifthen.sty, basically \setboolean calls the macro \<Boolean-Variable-Name><true-or-false>
	%By default, \setboolean is local to the group; we do the following to make the change global
	\globalsetboolean{#1@FirstUse}{false}%
%
	%Store the last used source, as well as pinpage and volume (if present) in that source, for determining Id
	\xdef\@bbLastSource{#1}%
	\protected@xdef\@bbLastPinPage{#2}%
	\ifthenelse{\not\equal{\@vol}{}}{\xdef\@bbLastVol{\@vol}}{}%
%
	%If in law review mode, store the footnote number, so we can force long cites after 5 footnotes
	\XDef{#1@LastNote}{\thefootnote}%
%
	%Record this use into the index, \pagenumber is the command that will be used to format
	\begingroup%
	\def\pin##1##2{}%
	\IfSubStr{#3}{*}{}{%
		\ifempty{\IndexType{#1}}{}{%
			\index{\IndexType{#1}}{\@bbIndexCite{#1}{#2}}%
		}%
	}%
	\endgroup%
%
	%Assume that we will capitalize the next Id, unless a signal word comes between
	\globalsetboolean{@bbCapNextSource}{true}%
	\def\@bbSignal{}%
%
	%Make sure to restore autofootnote (in case "!" was passed in, in which case it was redefined to do nothing)
	\let\@autofootnote=\@@autofootnote%
}

\def\@DefSignal#1{%
	\ifthenelse{\not \boolean{@bbLawReviewMode} \or \boolean{@bbInFootnote}}%
		{\globalsetboolean{@bbCapNextSource}{false}#1\xspace}%
		{\globalsetboolean{@bbCapNextSource}{false}\def\@bbSignal{#1 }}%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Parte traducida al español
\newcommand{\See}{\@DefSignal{\emph{V\'ease}}}
\newcommand{\Seealso}{\@DefSignal{\emph{V\'ease tambi\'en}}}
\newcommand{\Seeeg}{\@DefSignal{\emph{V\'ease, e.g.},}}
\newcommand{\Seegenerally}{\@DefSignal{\emph{V\'ease en general}}}
\newcommand{\Cf}{\@DefSignal{\emph{Cf.\@}}}

\newcommand{\Butsee}{\@DefSignal{\emph{Pero v\'ease}}}
\newcommand{\Butseeeg}{\@DefSignal{\emph{Pero v\'ease, e.g.},}}
\newcommand{\Butcf}{\@DefSignal{\emph{Pero cf.\@}}}

\newcommand{\Compare}{\@DefSignal{\emph{Comp\'arese con}}}
\newcommand{\Accord}{\@DefSignal{\emph{De acuerdo con}}}
\newcommand{\Contra}{\@DefSignal{\emph{Contrario a}}}

\renewcommand{\see}{\@DefSignal{\emph{v\'ease}}}
\newcommand{\seealso}{\@DefSignal{\emph{v\'ease tambi\'en}}}
\newcommand{\seeeg}{\@DefSignal{\emph{v\'ease, e.g.},}}
\newcommand{\cf}{\@DefSignal{\emph{cf.\@}}}

\newcommand{\butsee}{\@DefSignal{\emph{pero v\'ease}}}
\newcommand{\butseeeg}{\@DefSignal{\emph{pero v\'ease, e.g.},}}
\newcommand{\butcf}{\@DefSignal{\emph{pero cf.\@}}}

\newcommand{\compare}{\@defSignal{\emph{comp\'arese con}}}
\newcommand{\accord}{\@defSignal{\emph{de acuerdo con}}}
\newcommand{\contra}{\@defSignal{\emph{contrario a}}}

\newcommand{\etseq}{\emph{et seq.}}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\let\RealSectionSymbol=\S
\let\RealParaSymbol=\P
\protected\def\S{\RealSectionSymbol\xspace}
\protected\def\P{\RealParaSymbol\xspace}
\xspaceaddexceptions{\S \P}

\newcommand{\ellipsedotspacing}{2.5pt}
\def\ldots{\hbox{.\hspace{\ellipsedotspacing}.\hspace{\ellipsedotspacing}.}\xspace}
\def\ldotss{\hbox{.\hspace{\ellipsedotspacing}.\hspace{\ellipsedotspacing}.\hspace{\ellipsedotspacing}.}\xspace}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Parte traducida al español
\newcommand\Ordinal[1]{\ifcase\value{#1}Nulo\or Primero\or Segundo\or Tercero\or Cuarto\or Quinto\or Sexto\or S\'eptimo\or Octavo\or Noveno\or D\'ecimo\else \error{Contador demasiado grande para ordinales}\fi}
\newcommand\ordinal[1]{\ifcase\value{#1}nulo\or primero\or segundo\or tercero\or cuarto\or quinto\or sexto\or s\'eptimo\or octavo\or noveno\or d\'ecimo\else \error{Contador demasiado grande para ordinales}\fi}

\newcommand{\availableat}[1]{\protect\emph{disponible en} \protect\url{#1}}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\makeandletter{\catcode`\&=11}
\def\makeandtab{\catcode`\&=4}

\newcommand{\iffileexists}[3]{{%
  \newread\traux
  \openin\traux=#1\relax%
  \ifeof\traux%
  #3%
  \else%
  #2%
  \fi%
  \closein\traux%
}}

\def\printindex#1{\@input{#1.ind}}

%Court Documents: Case title and book title italicized
\def\CF{\em} %Case [Title] Format
\def\BTF{\em} %Book Title Format
\def\ATF{\em} %Article Title Format
\def\JTF{} %Journal Title Format
\def\BAF{} %Book Author Format
\def\PeriodOrComma{,}
\def\IfLawReview#1#2{#2}

\def\@bbSetLawReview{%
%
	\def\CF{} 			%Case [Title] Format
	\def\ATF{\em} 	%Article Title Format
	\def\JTF{\scshape} %Journal Title Format
	\def\BTF{\scshape} 	%Book Title Format
	\def\BAF{\scshape} 	%Book Author Format
%
	\let\@footnote\footnote%
	\def\footnote##1{%
		\setboolean{@bbInFootnote}{true}%
		\@footnote{##1}%
		\setboolean{@bbInFootnote}{false}%
	}%
%
	\setboolean{@bbLawReviewMode}{true}%
%
	\def\PeriodOrComma{.}%
	\def\IfLawReview##1##2{##1}%
}

\DeclareOption{lawreview}{\@bbSetLawReview}

\DeclareOption{casesupra}
{%
	\def\@bbCaseSupra{}%
}

\ProcessOptions

\def\indexglue{}
\def\indexpenalty{-10}
\def\idxbreak{\indexglue\penalty\indexpenalty} %Helper routine that combines the above two

\def\maxsequentialids{99}

\def\forcelongevery{5}
